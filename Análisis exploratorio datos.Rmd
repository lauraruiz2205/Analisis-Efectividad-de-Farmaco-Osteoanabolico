---
title: "Análisis exploratorio datos"
author: Isabel Montero Blázquez, Daniel Serrano Serrano, Alejandro Morales Alaminos,
  Constanza Paz Torres Rivera, Elena Simarro Álvarez y Laura Ruiz Almagro
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

Primero, cargamos las librerías.

```{r, message= FALSE}
library(ggplot2)
library(ggpubr)
library(summarytools)
library(psych)
library(dplyr)
library(purrr)
library(readxl)
library(scatterplot3d)
```

Importamos los datos. Como nuestro excel tiene tres pestañas, lo separamos en 3 data frames distintos. Datos1 para los datos del estudio 1, Datos2 para los del estudio 2 y Datos3 para los del estudio 3.

```{r}
Datos1<- read_excel("C:\\Users\\Laura\\Desktop\\Datos arreglados.xlsx",1)
#View(Datos1)
Datos2<- read_excel("C:\\Users\\Laura\\Desktop\\Datos arreglados.xlsx",2)
#View(Datos2)
Datos3<- read_excel("C:\\Users\\Laura\\Desktop\\Datos arreglados.xlsx",3)
#View(Datos3)
```

## Análisis exploratorio univariante
Datos ausentes (NA). Primero vemos qué datos son los que faltan. Observando las bases de datos, nos damos cuenta de que en el segundo estudio faltan BMC, BMD y longitud de las ratas con ID 222 y 223, y Tb.Sp, Tb.N, BMC,BMD, longitud, GPSurface, GPVolume de las ratas con ID 295 y 298. Tenemos que decidir si quitamos dichas ratas o simplemente omitimos los datos ausentes. Por ahora voy a trabajar omitiendo los datos ausentes. Vamos a realizar un análisis descriptivo separado por estudios.

### ESTUDIO 1
#### Peso inicial
```{r}
descr(Datos1[,14])
pesosiniciales1<-Datos1[[14]]
par(mfrow = c(1, 2),cex=0.7)
hist(pesosiniciales1, col="pink",xlab="Pesos iniciales", 
     ylab="Frecuencia", main="Distribución de los pesos iniciales estudio 1")
plot(density(pesosiniciales1), main="Densidad pesos iniciales estudio 1",
     xlab="Pesos iniciales", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(pesosiniciales1, main="Pesos iniciales estudio 1", outline=TRUE)
```

#### Peso intermedio
```{r}
descr(Datos1[,15])
pesosintermedios1<-Datos1[[15]]
par(mfrow = c(1, 2),cex=0.7)
hist(pesosintermedios1, col="pink", xlab="Pesos intermedios", 
     ylab="Frecuencia", main="Distribución de los pesos intermedios estudio 1")
plot(density(pesosintermedios1), main="Densidad pesos intermedios estudio 1",
     xlab="Pesos intermedios", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(pesosintermedios1, main="Pesos intermedios estudio 1", outline=TRUE)

```

#### Peso medición
```{r}
descr(Datos1[,6])
pesosmedicion1<-Datos1[[6]]
par(mfrow = c(1, 2),cex=0.7)
hist(pesosmedicion1, col="pink", xlab="Pesos medición",
     ylab="Frecuencia", main="Distribución de los pesos medición estudio 1")
plot(density(pesosmedicion1), main="Densidad pesos medición estudio 1",
     xlab="Pesos medición", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(pesosmedicion1, main="Pesos medición estudio 1", outline=TRUE)
```

#### Tb. N
```{r}
descr(Datos1[,8])
TbN1<-na.omit(Datos1[[8]])
par(mfrow = c(1, 2),cex=0.7)
hist(TbN1, col="pink", xlab="Número trabecular",
     ylab="Frecuencia", main="Distribución del número trabecular estudio 1")
plot(density(TbN1), main="Densidad número trabecular estudio 1",
     xlab="Número trabecular", ylab="Densidad") 
par(mfrow = c(1, 1))
boxplot(TbN1, main="Número trabecular estudio 1", outline=TRUE)

```

#### BMC
```{r}
descr(Datos1[,9])
BMC1<-na.omit(Datos1[[9]])
par(mfrow = c(1, 2),cex=0.7)
hist(BMC1, col="pink", xlab="BMC",
     ylab="Frecuencia", main="Distribución de BMC estudio 1")
plot(density(BMC1), main="Densidad BMC estudio 1",
     xlab="BMC", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(BMC1, main="BMC estudio 1", outline=TRUE)
```

#### BMD
```{r}
descr(Datos1[,10])
BMD1<-na.omit(Datos1[[10]])
par(mfrow = c(1, 2),cex=0.7)
hist(BMD1, col="pink", xlab="BMD",
     ylab="Frecuencia", main="Distribución de BMD estudio 1")
plot(density(BMD1), main="BMD estudio 1",
     xlab="BMD", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(BMD1, main="BMD estudio 1", outline=TRUE)
```

#### Longitud
```{r}
descr(Datos1[,11])
longitud1<-na.omit(Datos1[[11]])
par(mfrow = c(1, 2),cex=0.7)
hist(longitud1, col="pink", xlab="Longitud",
     ylab="Frecuencia", main="Distribución de longitudes estudio 1")
plot(density(longitud1), main="Densidad de la longitud estudio 1",
     xlab="Longitud", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(longitud1, main="Longitudes estudio 1", outline=TRUE)
```

#### GPSurface
```{r}
descr(Datos1[,12])
GPSurface1<-na.omit(Datos1[[12]])
par(mfrow = c(1, 2),cex=0.7)
hist(GPSurface1, col="pink", xlab="GPSurface",
     ylab="Frecuencia", main="Distribución de GPSurface estudio 1")
plot(density(GPSurface1), main="Densidad GPSurface estudio 1",
     xlab="GPSurface", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(GPSurface1, main="GPSurface estudio 1", outline=TRUE)

```

#### GPVolume
```{r}
descr(Datos1[,13])
GPVolume1<-na.omit(Datos1[[13]])
par(mfrow = c(1, 2),cex=0.7)
hist(GPVolume1, col="pink", xlab="GPVolume",
     ylab="Frecuencia", main="Distribución de GPVolume estudio 1")
plot(density(GPVolume1), main="Densidad GPVolume estudio 1",
     xlab="GPVolume", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(GPVolume1, main="GPVolume estudio 1", outline=TRUE)

```

#### Tb.Sp
```{r}
descr(Datos1[,7])
TbSp1<-na.omit(Datos1[[7]])
par(mfrow = c(1, 2),cex=0.7)
hist(TbSp1, col="pink", xlab="TbSp",
     ylab="Frecuencia", main="Distribución del espacio trabecular estudio 1")
plot(density(TbSp1), main="Densidad TbSp estudio 1",
     xlab="TbSp", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(TbSp1, main="TbSp estudio 1", outline=TRUE)
```

#### Outliers
```{r}
boxplot(Datos1[,6:15],main="Outliers",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```

Estandarizamos.
```{r}
sca<-scale(Datos1[,6:15])

boxplot(sca,main="Outliers",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```

### ESTUDIO 2
#### Peso inicial
```{r}
descr(Datos2[,14])
pesosiniciales2<-Datos2[[14]]
par(mfrow = c(1, 2),cex=0.7)
hist(pesosiniciales2, col="pink", xlab="Pesos iniciales", 
     ylab="Frecuencia", main="Distribución de los pesos iniciales estudio 2")
plot(density(pesosiniciales2), main="Densidad pesos iniciales estudio 2",
     xlab="Pesos iniciales", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(pesosiniciales2, main="Pesos iniciales estudio 2", outline=TRUE)

```

#### Peso intermedio
```{r}
descr(Datos2[,15])
pesosintermedios2<-Datos2[[15]]
par(mfrow = c(1, 2),cex=0.7)
hist(pesosintermedios2, col="pink", xlab="Pesos intermedios", 
     ylab="Frecuencia", main="Distribución de los pesos intermedios estudio 2")
plot(density(pesosintermedios2), main="Densidad pesos intermedios estudio 2",
     xlab="Pesos intermedios", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(pesosintermedios2, main="Pesos intermedios estudio 2", outline=TRUE)

```

#### Peso medición
```{r}
descr(Datos2[,6])
pesosmedicion2<-Datos2[[6]]
par(mfrow = c(1, 2),cex=0.7)
hist(pesosmedicion2, col="pink", xlab="Pesos medición",
     ylab="Frecuencia", main="Distribución de los pesos medición estudio 2")
plot(density(pesosmedicion2), main="Densidad pesos medición estudio 2",
     xlab="Pesos medición", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(pesosmedicion2, main="Pesos medición estudio 2", outline=TRUE)

```

#### Tb. N
```{r}
descr(Datos2[,8])
TbN2<-na.omit(Datos2[[8]])
par(mfrow = c(1, 2),cex=0.7)
hist(TbN2, col="pink", xlab="Número trabecular",
     ylab="Frecuencia", main="Distribución del número trabecular estudio 2")
plot(density(TbN2), main="Densidad número trabecular estudio 2",
     xlab="Número trabecular", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(TbN2, main="Número trabecular estudio 2", outline=TRUE)

```

#### BMC
```{r}
descr(Datos2[,9])
BMC2<-na.omit(Datos2[[9]])
par(mfrow = c(1, 2),cex=0.7)
hist(BMC2, col="pink", xlab="BMC",
     ylab="Frecuencia", main="Distribución de BMC estudio 2")
plot(density(BMC2), main="Densidad BMC estudio 2",
     xlab="BMC", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(BMC2, main="BMC estudio 2", outline=TRUE)
```

#### BMD
```{r}
descr(Datos2[,10])
BMD2<-na.omit(Datos2[[10]])
par(mfrow = c(1, 2),cex=0.7)
hist(BMD2, col="pink", xlab="BMD",
     ylab="Frecuencia", main="Distribución de BMD estudio 2")
plot(density(BMD2), main="BMD estudio 2",
     xlab="BMD", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(BMD2, main="BMD estudio 2", outline=TRUE)
```

#### Longitud
```{r}
descr(Datos2[,11])
longitud2<-na.omit(Datos2[[11]])
par(mfrow = c(1, 2),cex=0.7)
hist(longitud2, col="pink", xlab="Longitud",
     ylab="Frecuencia", main="Distribución de longitudes estudio 2")
plot(density(longitud2), main="Densidad de la longitud estudio 2",
     xlab="Longitud", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(longitud2, main="Longitudes estudio 2", outline=TRUE)

```

#### GPSurface
```{r}
descr(Datos2[,12])
GPSurface2<-na.omit(Datos2[[12]])
par(mfrow = c(1, 2),cex=0.7)
hist(GPSurface2, col="pink", xlab="GPSurface",
     ylab="Frecuencia", main="Distribución de GPSurface estudio 2")
plot(density(GPSurface2), main="Densidad GPSurface estudio 2",
     xlab="GPSurface", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(GPSurface2, main="GPSurface estudio 2", outline=TRUE)

```

#### GPVolume
```{r}
descr(Datos2[,13])
GPVolume2<-na.omit(Datos2[[13]])
par(mfrow = c(1, 2),cex=0.7)
hist(GPVolume2, col="pink", xlab="GPVolume",
     ylab="Frecuencia", main="Distribución de GPVolume estudio 2")
plot(density(GPVolume2), main="Densidad GPVolume estudio 2",
     xlab="GPVolume", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(GPVolume2, main="GPVolume estudio 2", outline=TRUE)

```

#### Tb.Sp
```{r}
descr(Datos2[,7])
TbSp2<-na.omit(Datos2[[7]])
par(mfrow = c(1, 2),cex=0.7)
hist(TbSp2, col="pink", xlab="TbSp",
     ylab="Frecuencia", main="Distribución del espacio trabecular estudio 2")
plot(density(TbSp2), main="Densidad TbSp estudio 2",
     xlab="TbSp", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(TbSp2, main="TbSp estudio 2", outline=TRUE)
```

#### Outliers
```{r}
boxplot(Datos2[,6:15],main="Outliers",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```

Estandarizamos.
```{r}
sca<-scale(Datos2[,6:15])

boxplot(sca,main="Outliers",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```

### ESTUDIO 3
#### Peso inicial
```{r}
descr(Datos3[,14])
pesosiniciales3<-Datos3[[14]]
par(mfrow = c(1, 2),cex=0.7)
hist(pesosiniciales3, col="pink", xlab="Pesos iniciales", 
     ylab="Frecuencia", main="Distribución de los pesos iniciales estudio 3")
plot(density(pesosiniciales3), main="Densidad pesos iniciales estudio 3",
     xlab="Pesos iniciales", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(pesosiniciales3, main="Pesos iniciales estudio 3", outline=TRUE)

```

#### Peso intermedio
```{r}
descr(Datos3[,15])
pesosintermedios3<-Datos3[[15]]
par(mfrow = c(1, 2),cex=0.7)
hist(pesosintermedios3, col="pink", xlab="Pesos intermedios", 
     ylab="Frecuencia", main="Distribución de los pesos intermedios estudio 3")
plot(density(pesosintermedios3), main="Densidad pesos intermedios estudio 3",
     xlab="Pesos intermedios", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(pesosintermedios3, main="Pesos intermedios estudio 3", outline=TRUE)

```

#### Peso medición
```{r}
descr(Datos3[,6])
pesosmedicion3<-Datos3[[6]]
par(mfrow = c(1, 2),cex=0.7)
hist(pesosmedicion3, col="pink", xlab="Pesos medición",
     ylab="Frecuencia", main="Distribución de los pesos medición estudio 3")
plot(density(pesosmedicion3), main="Densidad pesos medición estudio 3",
     xlab="Pesos medición", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(pesosmedicion3, main="Pesos medición estudio 3", outline=TRUE)

```

#### Tb. N
```{r}
descr(Datos3[,8])
TbN3<-na.omit(Datos3[[8]])
par(mfrow = c(1, 2),cex=0.7)
hist(TbN3, col="pink", xlab="Número trabecular",
     ylab="Frecuencia", main="Distribución del número trabecular estudio 3")
plot(density(TbN3), main="Densidad número trabecular estudio 3",
     xlab="Número trabecular", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(TbN3, main="Número trabecular estudio 3", outline=TRUE)

```

#### BMC
```{r}
descr(Datos3[,9])
BMC3<-na.omit(Datos3[[9]])
par(mfrow = c(1, 2),cex=0.7)
hist(BMC3, col="pink", xlab="BMC",
     ylab="Frecuencia", main="Distribución de BMC estudio 3")
plot(density(BMC3), main="Densidad BMC estudio 3",
     xlab="BMC", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(BMC3, main="BMC estudio 3", outline=TRUE)
```

#### BMD
```{r}
descr(Datos3[,10])
BMD3<-na.omit(Datos3[[10]])
par(mfrow = c(1, 2),cex=0.7)
hist(BMD3, col="pink", xlab="BMD",
     ylab="Frecuencia", main="Distribución de BMD estudio 3")
plot(density(BMD3), main="BMD estudio 3",
     xlab="BMD", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(BMD3, main="BMD estudio 3", outline=TRUE)

```

#### Longitud
```{r}
descr(Datos3[,11])
longitud3<-na.omit(Datos3[[11]])
par(mfrow = c(1, 2),cex=0.7)
hist(longitud3, col="pink", xlab="Longitud",
     ylab="Frecuencia", main="Distribución de longitudes estudio 3")
plot(density(longitud3), main="Densidad de la longitud estudio 3",
     xlab="Longitud", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(longitud3, main="Longitudes estudio 3", outline=TRUE)

```

#### GPSurface
```{r}
descr(Datos3[,12])
GPSurface3<-na.omit(Datos3[[12]])
par(mfrow = c(1, 2),cex=0.7)
hist(GPSurface3, col="pink", xlab="GPSurface",
     ylab="Frecuencia", main="Distribución de GPSurface estudio 3")
plot(density(GPSurface3), main="Densidad GPSurface estudio 3",
     xlab="GPSurface", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(GPSurface3, main="GPSurface estudio 3", outline=TRUE)
```

#### GPVolume
```{r}
descr(Datos3[,13])
GPVolume3<-na.omit(Datos3[[13]])
par(mfrow = c(1, 2),cex=0.7)
hist(GPVolume3, col="pink", xlab="GPVolume",
     ylab="Frecuencia", main="Distribución de GPVolume estudio 3")
plot(density(GPVolume3), main="Densidad GPVolume estudio 3",
     xlab="GPVolume", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(GPVolume3, main="GPVolume estudio 3", outline=TRUE)

```

#### Tb.Sp
```{r}
descr(Datos3[,7])
TbSp3<-na.omit(Datos3[[7]])
par(mfrow = c(1, 2),cex=0.7)
hist(TbSp3, col="pink", xlab="TbSp",
     ylab="Frecuencia", main="Distribución del espacio trabecular estudio 3")
plot(density(TbSp3), main="Densidad TbSp estudio 3",
     xlab="TbSp", ylab="Densidad")
par(mfrow = c(1, 1))
boxplot(TbSp3, main="TbSp estudio 3", outline=TRUE)

```

#### Outliers
```{r}
boxplot(Datos3[,6:15],main="Outliers",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```

Estandarizamos.
```{r}
sca<-scale(Datos3[,6:15])

boxplot(sca,main="Outliers",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```



Vamos a superponer los histogramas para ver cómo cambian las variables en función de la dosis.

### Estudio 1

```{r}
par(mfrow = c(1, 2),cex=0.7)
p1_1<-ggplot(data=Datos1,aes(x=PesoInicial,fill=factor(Dosis))) +
    geom_histogram(position = "identity", alpha = 0.5, bins=20)
p2_1<-ggplot(data=Datos1,aes(x=PesoIntermedio,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p3_1<-ggplot(data=Datos1,aes(x=PesoFinal,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p4_1<-ggplot(data=Datos1,aes(x=Tb.N,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p5_1<-ggplot(data=Datos1,aes(x=Tb.Sp,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p6_1<-ggplot(data=Datos1,aes(x=BMC,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p7_1<-ggplot(data=Datos1,aes(x=BMD,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p8_1<-ggplot(data=Datos1,aes(x=Longitud,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p9_1<-ggplot(data=Datos1,aes(x=GPSurface,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p10_1<-ggplot(data=Datos1,aes(x=GPVolume,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)

ggarrange(p1_1,p2_1, p3_1,p4_1,p5_1,p6_1,p7_1,p8_1,p9_1,p10_1, nrow = 4, ncol=3, common.legend = TRUE)

```

### Estudio 2

```{r}
Datos2.2<-na.omit(Datos2)
par(mfrow = c(1, 2),cex=0.7)
p1_2<-ggplot(data=Datos2.2,aes(x=PesoInicial,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p2_2<-ggplot(data=Datos2.2,aes(x=PesoIntermedio,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p3_2<-ggplot(data=Datos2.2,aes(x=PesoFinal,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p4_2<-ggplot(data=Datos2.2,aes(x=Tb.N,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p5_2<-ggplot(data=Datos2.2,aes(x=Tb.Sp,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p6_2<-ggplot(data=Datos2.2,aes(x=BMC,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p7_2<-ggplot(data=Datos2.2,aes(x=BMD,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p8_2<-ggplot(data=Datos2.2,aes(x=Longitud,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p9_2<-ggplot(data=Datos2.2,aes(x=GPSurface,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p10_2<-ggplot(data=Datos2.2,aes(x=GPVolume,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)

ggarrange(p1_2,p2_2, p3_2,p4_2,p5_2,p6_2,p7_2,p8_2,p9_2,p10_2, nrow = 4, ncol=3, common.legend = TRUE)

```

### Estudio 3

```{r}
par(mfrow = c(1, 2),cex=0.7)
p1_3<-ggplot(data=Datos3,aes(x=PesoInicial,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p2_3<-ggplot(data=Datos3,aes(x=PesoIntermedio,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p3_3<-ggplot(data=Datos3,aes(x=PesoFinal,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p4_3<-ggplot(data=Datos3,aes(x=Tb.N,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p5_3<-ggplot(data=Datos3,aes(x=Tb.Sp,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p6_3<-ggplot(data=Datos3,aes(x=BMC,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p7_3<-ggplot(data=Datos3,aes(x=BMD,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p8_3<-ggplot(data=Datos3,aes(x=Longitud,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p9_3<-ggplot(data=Datos3,aes(x=GPSurface,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)
p10_3<-ggplot(data=Datos3,aes(x=GPVolume,fill=factor(Dosis))) +
  geom_histogram(position = "identity", alpha = 0.5, bins=20)

ggarrange(p1_3,p2_3, p3_3,p4_3,p5_3,p6_3,p7_3,p8_3,p9_3,p10_3, nrow = 4, ncol=3, common.legend = TRUE)

```

En general parece que el peso intermedio, el BMC y la longitud separan mejor al grupo de control.
Ahora vamos a realizar un análisis exploratorio visual bivariante.

## Análisis exploratorio bivariante

### Estudio 1

```{r}

pairs(Datos1[, c("PesoInicial", "PesoIntermedio", "PesoFinal", "Tb.N", "Tb.Sp", "BMC", "BMD", "Longitud", "GPSurface", "GPVolume")],
      col = rainbow(length(levels(factor(Datos1$Dosis))))[factor(Datos1$Dosis)],
      pch = 19)
legend("topright", 
       legend = levels(factor(Datos1$Dosis)), 
       fill = rainbow(length(levels(factor(Datos1$Dosis)))))
```

Observamos las correlaciones por estudio.
```{r, message=FALSE}
library(corrplot)
```

```{r}
corrplot(cor(Datos1[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)
```

Correlaciones por dosis, estudio 1
```{r}
dato1dosis0<-subset(Datos1,Dosis==0)
dato1dosis1<-subset(Datos1,Dosis==1)
dato1dosis8<-subset(Datos1,Dosis==8)
dato1dosis10<-subset(Datos1,Dosis==10)
dato1dosis80<-subset(Datos1,Dosis==80)
dato1dosis100<-subset(Datos1,Dosis==100)

par(mfrow = c(1, 2))
corrplot(cor(dato1dosis0[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)
corrplot(cor(dato1dosis1[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)
corrplot(cor(dato1dosis8[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)
corrplot(cor(dato1dosis10[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)
corrplot(cor(dato1dosis80[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)
corrplot(cor(dato1dosis100[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)

```


### Estudio 2
Omitimos los valores perdidos del Estudio 2 para hacer la gráfica. No sería un error eliminarlos ya que son menos del 5%.
```{r}
Datos2.2<-na.omit(Datos2)
pairs(Datos2.2[, c("PesoInicial", "PesoIntermedio", "PesoFinal", "Tb.N", "Tb.Sp", "BMC", "BMD", "Longitud", "GPSurface", "GPVolume")],
      col = rainbow(length(levels(factor(Datos2.2$Dosis))))[factor(Datos2.2$Dosis)],pch = 19)
legend("topright", 
       legend = levels(factor(Datos2.2$Dosis)), 
       fill = rainbow(length(levels(factor(Datos2.2$Dosis)))))
```

Observamos las correlaciones por estudio.
```{r}
corrplot(cor(Datos2.2[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)
```

Correlaciones por dosis, estudio 2
```{r}
dato2dosis0<-subset(Datos2.2,Dosis==0)
dato2dosis80<-subset(Datos2.2,Dosis==80)
dato2dosis400<-subset(Datos2.2,Dosis==400)

par(mfrow = c(1, 2))
corrplot(cor(dato2dosis0[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)
corrplot(cor(dato2dosis80[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)
corrplot(cor(dato2dosis400[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)

```

### Estudio 3
```{r}

pairs(Datos3[, c("PesoInicial", "PesoIntermedio", "PesoFinal", "Tb.N", "Tb.Sp", "BMC", "BMD", "Longitud", "GPSurface", "GPVolume")],
      col = rainbow(length(levels(factor(Datos3$Dosis))))[factor(Datos3$Dosis)],pch = 19)
legend("topright", 
       legend = levels(factor(Datos3$Dosis)), 
       fill = rainbow(length(levels(factor(Datos3$Dosis)))))
```

Observamos las correlaciones por estudio.
```{r}
corrplot(cor(Datos3[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)
```

Correlaciones por dosis, estudio 3
```{r}
dato3dosis0<-subset(Datos3,Dosis==0)
dato3dosis500<-subset(Datos3,Dosis==500)
dato3dosis1000<-subset(Datos3,Dosis==1000)

par(mfrow = c(1, 2))
corrplot(cor(dato3dosis0[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)
corrplot(cor(dato3dosis500[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)
corrplot(cor(dato3dosis1000[6:15]), order = "hclust", tl.col='black', tl.cex=0.6)

```


## Análisis exploratorio trivariante
Finalmente, nos queda hacer un análisis exploratorio visual trivariante
Comparamos peso intermedio, longitud, BMC, BMD, GPSurface y Tb.Sp que en los gráficos de histogramas parecían los que más información nos aportaban.


### Estudio 1

```{r}
Datos1Factor <- Datos1
Datos2.2Factor <- Datos2.2
Datos3Factor <- Datos3
Datos1Factor$Dosis <- factor(Datos1Factor$Dosis)
Datos2.2Factor$Dosis <- factor(Datos2.2Factor$Dosis)
Datos3Factor$Dosis <- factor(Datos3Factor$Dosis)

par(mfrow = c(1, 2),cex=0.7)
#####
scatterplot3d(Datos1$PesoInicial, Datos1$PesoIntermedio, Datos1$PesoFinal,
              color = rainbow(length(levels(Datos1Factor$Dosis)))[as.factor(Datos1$Dosis)],
              pch = 19, grid = TRUE, xlab = "Peso Inicial", ylab = "Peso Intermedio", zlab = "Peso Final",
              angle = 65, cex.axis = 0.6)

legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(factor(Datos1$Dosis)), fill = rainbow(length(levels(factor(Datos1$Dosis)))))
#####
scatterplot3d(Datos1$Longitud, Datos1$PesoIntermedio, Datos1$BMC,
              color = rainbow(length(levels(Datos1Factor$Dosis)))[as.factor(Datos1$Dosis)], pch = 19,
              grid = TRUE, xlab = "Longitud", ylab = "Peso Intermedio", zlab = "BMC",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos1Factor$Dosis), fill = rainbow(length(levels(Datos1Factor$Dosis))))
####
scatterplot3d(Datos1Factor$GPSurface, Datos1Factor$PesoIntermedio, Datos1Factor$BMC,
              color = rainbow(length(levels(Datos1Factor$Dosis)))[Datos1Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "GPSurface", ylab = "Peso Intermedio", zlab = "BMC",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos1Factor$Dosis), fill = rainbow(length(levels(Datos1Factor$Dosis))))
####
scatterplot3d(Datos1Factor$GPSurface, Datos1Factor$PesoIntermedio, Datos1Factor$Longitud,
              color = rainbow(length(levels(Datos1Factor$Dosis)))[Datos1Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "GPSurface", ylab = "Peso Intermedio", zlab = "Longitud",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos1Factor$Dosis), fill = rainbow(length(levels(Datos1Factor$Dosis))))
####
scatterplot3d(Datos1Factor$BMD, Datos1Factor$PesoIntermedio, Datos1Factor$Tb.Sp,
              color = rainbow(length(levels(Datos1Factor$Dosis)))[Datos1Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "BMD", ylab = "Peso Intermedio", zlab = "Tb.Sp",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos1Factor$Dosis), fill = rainbow(length(levels(Datos1Factor$Dosis))))
#####
scatterplot3d(Datos1Factor$BMD, Datos1Factor$PesoIntermedio, Datos1Factor$Longitud,
              color = rainbow(length(levels(Datos1Factor$Dosis)))[Datos1Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "BMD", ylab = "Peso Intermedio", zlab = "Longitud",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos1Factor$Dosis), fill = rainbow(length(levels(Datos1Factor$Dosis))))
#####
scatterplot3d(Datos1Factor$BMC, Datos1Factor$PesoIntermedio, Datos1Factor$Tb.Sp,
              color = rainbow(length(levels(Datos1Factor$Dosis)))[Datos1Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "BMC", ylab = "Peso Intermedio", zlab = "Tb.Sp",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos1Factor$Dosis), fill = rainbow(length(levels(Datos1Factor$Dosis))))
#####
scatterplot3d(Datos1Factor$BMD, Datos1Factor$PesoIntermedio, Datos1Factor$GPSurface,
              color = rainbow(length(levels(Datos1Factor$Dosis)))[Datos1Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "BMD", ylab = "Peso Intermedio", zlab = "GPSurface",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos1Factor$Dosis), fill = rainbow(length(levels(Datos1Factor$Dosis))))


```

### Estudio 2

```{r}
par(mfrow = c(1, 2),cex=0.7)

scatterplot3d(Datos2.2$PesoInicial, Datos2.2$PesoIntermedio, Datos2.2$PesoFinal,
              color = rainbow(length(levels(factor(Datos2.2$Dosis))))[as.factor(Datos2.2$Dosis)],
              pch = 19, grid = TRUE, xlab = "Peso Inicial", ylab = "Peso Intermedio", zlab = "Peso Final",
              angle = 65, cex.axis = 0.6)

legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(factor(Datos2.2$Dosis)), fill = rainbow(length(levels(factor(Datos2.2$Dosis)))))
#####
scatterplot3d(Datos2.2Factor$Longitud, Datos2.2Factor$PesoIntermedio, Datos2.2Factor$BMC,
              color = rainbow(length(levels(Datos2.2Factor$Dosis)))[Datos2.2Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "Longitud", ylab = "Peso Intermedio", zlab = "BMC",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos2.2Factor$Dosis), fill = rainbow(length(levels(Datos2.2Factor$Dosis))))
#####
scatterplot3d(Datos2.2Factor$GPSurface, Datos2.2Factor$PesoIntermedio, Datos2.2Factor$BMC,
              color = rainbow(length(levels(Datos2.2Factor$Dosis)))[Datos2.2Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "GPSurface", ylab = "Peso Intermedio", zlab = "BMC",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos2.2Factor$Dosis), fill = rainbow(length(levels(Datos2.2Factor$Dosis))))
######
scatterplot3d(Datos2.2Factor$GPSurface, Datos2.2Factor$PesoIntermedio, Datos2.2Factor$Longitud,
              color = rainbow(length(levels(Datos2.2Factor$Dosis)))[Datos2.2Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "GPSurface", ylab = "Peso Intermedio", zlab = "Longitud",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos2.2Factor$Dosis), fill = rainbow(length(levels(Datos2.2Factor$Dosis))))
#######
scatterplot3d(Datos2.2Factor$BMD, Datos2.2Factor$PesoIntermedio, Datos2.2Factor$Tb.Sp,
              color = rainbow(length(levels(Datos2.2Factor$Dosis)))[Datos2.2Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "BMD", ylab = "Peso Intermedio", zlab = "Tb.Sp",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos2.2Factor$Dosis), fill = rainbow(length(levels(Datos2.2Factor$Dosis))))
######
scatterplot3d(Datos2.2Factor$BMD, Datos2.2Factor$PesoIntermedio, Datos2.2Factor$Longitud,
              color = rainbow(length(levels(Datos2.2Factor$Dosis)))[Datos2.2Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "BMD", ylab = "Peso Intermedio", zlab = "Longitud",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos2.2Factor$Dosis), fill = rainbow(length(levels(Datos2.2Factor$Dosis))))
#######
scatterplot3d(Datos2.2Factor$BMC, Datos2.2Factor$PesoIntermedio, Datos2.2Factor$Tb.Sp,
              color = rainbow(length(levels(Datos2.2Factor$Dosis)))[Datos2.2Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "BMC", ylab = "Peso Intermedio", zlab = "Tb.Sp",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos2.2Factor$Dosis), fill = rainbow(length(levels(Datos2.2Factor$Dosis))))
######
scatterplot3d(Datos2.2Factor$BMD, Datos2.2Factor$PesoIntermedio, Datos2.2Factor$GPSurface,
              color = rainbow(length(levels(Datos2.2Factor$Dosis)))[Datos2.2Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "BMD", ylab = "Peso Intermedio", zlab = "GPSurface",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos2.2Factor$Dosis), fill = rainbow(length(levels(Datos2.2Factor$Dosis))))


```

### Estudio 3

```{r}
par(mfrow = c(1, 2),cex=0.7)

scatterplot3d(Datos3$PesoInicial, Datos3$PesoIntermedio, Datos3$PesoFinal,
              color = rainbow(length(levels(factor(Datos3$Dosis))))[as.factor(Datos3$Dosis)],
              pch = 19, grid = TRUE, xlab = "Peso Inicial", ylab = "Peso Intermedio", zlab = "Peso Final",
              angle = 65, cex.axis = 0.6)

legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(factor(Datos3$Dosis)), fill = rainbow(length(levels(factor(Datos3$Dosis)))))
#####
scatterplot3d(Datos3Factor$Longitud, Datos3Factor$PesoIntermedio, Datos3Factor$BMC,
              color = rainbow(length(levels(Datos3Factor$Dosis)))[Datos3Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "Longitud", ylab = "Peso Intermedio", zlab = "BMC",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos3Factor$Dosis), fill = rainbow(length(levels(Datos3Factor$Dosis))))
######
scatterplot3d(Datos3Factor$GPSurface, Datos3Factor$PesoIntermedio, Datos3Factor$BMC,
              color = rainbow(length(levels(Datos3Factor$Dosis)))[Datos3Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "GPSurface", ylab = "Peso Intermedio", zlab = "BMC",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos3Factor$Dosis), fill = rainbow(length(levels(Datos3Factor$Dosis))))
#######
scatterplot3d(Datos3Factor$GPSurface, Datos3Factor$PesoIntermedio, Datos3Factor$Longitud,
              color = rainbow(length(levels(Datos3Factor$Dosis)))[Datos3Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "GPSurface", ylab = "Peso Intermedio", zlab = "Longitud",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos3Factor$Dosis), fill = rainbow(length(levels(Datos3Factor$Dosis))))
#########
scatterplot3d(Datos3Factor$BMD, Datos3Factor$PesoIntermedio, Datos3Factor$Tb.Sp,
              color = rainbow(length(levels(Datos3Factor$Dosis)))[Datos3Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "GPSurface", ylab = "Peso Intermedio", zlab = "Tb.Sp",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos3Factor$Dosis), fill = rainbow(length(levels(Datos3Factor$Dosis))))
#########
scatterplot3d(Datos3Factor$BMD, Datos3Factor$PesoIntermedio, Datos3Factor$Longitud,
              color = rainbow(length(levels(Datos3Factor$Dosis)))[Datos3Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "BMD", ylab = "Peso Intermedio", zlab = "Longitud",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos3Factor$Dosis), fill = rainbow(length(levels(Datos3Factor$Dosis))))
#######
scatterplot3d(Datos3Factor$BMD, Datos3Factor$PesoIntermedio, Datos3Factor$Tb.Sp,
              color = rainbow(length(levels(Datos3Factor$Dosis)))[Datos3Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "GPSurface", ylab = "Peso Intermedio", zlab = "Tb.Sp",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos3Factor$Dosis), fill = rainbow(length(levels(Datos3Factor$Dosis))))
#######
scatterplot3d(Datos3Factor$BMC, Datos3Factor$PesoIntermedio, Datos3Factor$GPSurface,
              color = rainbow(length(levels(Datos3Factor$Dosis)))[Datos3Factor$Dosis], pch = 19,
              grid = TRUE, xlab = "BMC", ylab = "Peso Intermedio", zlab = "GPSurface",
              angle = 65, cex.axis = 0.6)
legend("topright", bty = "n", cex = 0.8, title = "Dosis",
       legend = levels(Datos3Factor$Dosis), fill = rainbow(length(levels(Datos3Factor$Dosis))))

```

## Tratamiento de outliers
Todo el análisis que hemos hecho anteriormente ha sido sin quitar los outliers. Hay tres formas de gestionar los outliers: dejarlos, eliminarlos y cambiarlos por la media.

### Estudio 1

#### Eliminar los outliers

```{r}
# Función para eliminar outliers de columnas específicas
eliminar_outliers_columnas <- function(datos, columnas) {
  # Inicializar el dataframe sin outliers
  datos_sin_outliers <- datos
  
  for (columna in columnas) {
    # Calcular los cuartiles y el IQR de la columna
    Q1 <- quantile(datos[[columna]], 0.25)
    Q3 <- quantile(datos[[columna]], 0.75)
    IQR <- Q3 - Q1
    
    # Definir los límites inferior y superior
    limite_inferior <- Q1 - 1.5 * IQR
    limite_superior <- Q3 + 1.5 * IQR
    
    # Filtrar las filas que están dentro de los límites
    datos_sin_outliers <- datos_sin_outliers[datos_sin_outliers[[columna]] >= limite_inferior & datos_sin_outliers[[columna]] <= limite_superior, ]
  }
  
  return(datos_sin_outliers)
}

columnas_a_usar <- c(6:15)
Datos1_sin_outliers <- eliminar_outliers_columnas(Datos1, columnas_a_usar)
#print(Datos1_sin_outliers)
```
Comprobemos gráficamente la eliminación de los outliers.

```{r}
par(mfrow = c(1, 2))
boxplot(Datos1[,6:15],main="Outliers antes de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
boxplot(Datos1_sin_outliers[,6:15],main="Outliers después de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```

Estandarizamos.
```{r}
par(mfrow = c(1, 2))
sca<-scale(Datos1[,6:15])

boxplot(sca,main="Outliers antes de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))

sca_sin_outliers<-scale(Datos1_sin_outliers[,6:15])

boxplot(sca_sin_outliers,main="Outliers después de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```

#### Cambiar los outliers por la media

```{r}
outlier<-function(data,na.rm=T){
  H<-1.5*IQR(data) 
  data[data<quantile(data,0.25,na.rm = T)-H]<-NA 
  data[data>quantile(data,0.75, na.rm = T)+H]<-NA 
  data[is.na(data)]<-mean(data, na.rm = T) 
  H<-1.5*IQR(data)
  
  if (TRUE %in% (data<quantile(data,0.25,na.rm = T)-H) | 
      TRUE %in% (data>quantile(data,0.75,na.rm = T)+H))
    outlier(data) 
  else
    return(data) 
}
Datos1_con_media<-Datos1

Datos1_con_media[[6]]<-outlier(Datos1_con_media[[6]]) 
Datos1_con_media[[7]]<-outlier(Datos1_con_media[[7]])  
Datos1_con_media[[8]]<-outlier(Datos1_con_media[[8]]) 
Datos1_con_media[[9]]<-outlier(Datos1_con_media[[9]]) 
Datos1_con_media[[10]]<-outlier(Datos1_con_media[[10]]) 
Datos1_con_media[[11]]<-outlier(Datos1_con_media[[11]]) 
Datos1_con_media[[12]]<-outlier(Datos1_con_media[[12]]) 
Datos1_con_media[[13]]<-outlier(Datos1_con_media[[13]]) 
Datos1_con_media[[14]]<-outlier(Datos1_con_media[[14]]) 
Datos1_con_media[[15]]<-outlier(Datos1_con_media[[15]]) 
```

Comprobemos gráficamente el cambio de los outliers por la media.

```{r}
par(mfrow = c(1, 2))
boxplot(Datos1[,6:15],main="Outliers antes de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
boxplot(Datos1_con_media[,6:15],main="Outliers después de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```


Estandarizamos.
```{r}
par(mfrow = c(1, 2))
sca<-scale(Datos1[,6:15])

boxplot(sca,main="Outliers antes de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))

sca_sin_outliers1<-scale(Datos1_con_media[,6:15])

boxplot(sca_sin_outliers,main="Outliers después de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```

### Estudio 2

#### Eliminar los outliers

```{r}
# Función para eliminar outliers de columnas específicas
eliminar_outliers_columnas <- function(datos, columnas) {
  # Inicializar el dataframe sin outliers
  datos_sin_outliers <- datos
  
  for (columna in columnas) {
    # Calcular los cuartiles y el IQR de la columna
    Q1 <- quantile(datos[[columna]], 0.25)
    Q3 <- quantile(datos[[columna]], 0.75)
    IQR <- Q3 - Q1
    
    # Definir los límites inferior y superior
    limite_inferior <- Q1 - 1.5 * IQR
    limite_superior <- Q3 + 1.5 * IQR
    
    # Filtrar las filas que están dentro de los límites
    datos_sin_outliers <- datos_sin_outliers[datos_sin_outliers[[columna]] >= limite_inferior & datos_sin_outliers[[columna]] <= limite_superior, ]
  }
  
  return(datos_sin_outliers)
}

columnas_a_usar <- c(6:15)
Datos2.2_sin_outliers <- eliminar_outliers_columnas(Datos2.2, columnas_a_usar)
#print(Datos2.2_sin_outliers)
```
Comprobemos gráficamente la eliminación de los outliers.

```{r}
par(mfrow = c(1, 2))
boxplot(Datos2.2[,6:15],main="Outliers antes de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
boxplot(Datos2.2_sin_outliers[,6:15],main="Outliers después de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```

Estandarizamos.
```{r}
par(mfrow = c(1, 2))
sca<-scale(Datos2.2[,6:15])

boxplot(sca,main="Outliers antes de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))

sca_sin_outliers<-scale(Datos2.2_sin_outliers[,6:15])

boxplot(sca_sin_outliers,main="Outliers después de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```

#### Cambiar los outliers por la media

```{r}
outlier<-function(data,na.rm=T){
  H<-1.5*IQR(data) 
  data[data<quantile(data,0.25,na.rm = T)-H]<-NA 
  data[data>quantile(data,0.75, na.rm = T)+H]<-NA 
  data[is.na(data)]<-mean(data, na.rm = T) 
  H<-1.5*IQR(data)
  
  if (TRUE %in% (data<quantile(data,0.25,na.rm = T)-H) | 
      TRUE %in% (data>quantile(data,0.75,na.rm = T)+H))
    outlier(data) 
  else
    return(data) 
}

Datos2.2_con_media<-Datos2.2

#Llamamos a la función de outliers para cada variable en la que hemos identificado un outlier
#Sería suficiente fijarnos en las gráficas donde hay outliers y no llamar a la función para todas las variables


Datos2.2_con_media[[6]]<-outlier(Datos2.2_con_media[[6]]) 
Datos2.2_con_media[[7]]<-outlier(Datos2.2_con_media[[7]])  
Datos2.2_con_media[[8]]<-outlier(Datos2.2_con_media[[8]]) 
Datos2.2_con_media[[9]]<-outlier(Datos2.2_con_media[[9]]) 
Datos2.2_con_media[[10]]<-outlier(Datos2.2_con_media[[10]]) 
Datos2.2_con_media[[11]]<-outlier(Datos2.2_con_media[[11]]) 
Datos2.2_con_media[[12]]<-outlier(Datos2.2_con_media[[12]]) 
Datos2.2_con_media[[13]]<-outlier(Datos2.2_con_media[[13]]) 
Datos2.2_con_media[[14]]<-outlier(Datos2.2_con_media[[14]]) 
Datos2.2_con_media[[15]]<-outlier(Datos2.2_con_media[[15]])
```

Comprobemos gráficamente el cambio de los outliers por la media.

```{r}
par(mfrow = c(1, 2))
boxplot(Datos2.2[,6:15],main="Outliers antes de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
boxplot(Datos2.2_con_media[,6:15],main="Outliers después de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```


Estandarizamos.
```{r}
par(mfrow = c(1, 2))
sca<-scale(Datos2.2[,6:15])

boxplot(sca,main="Outliers antes de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))

sca_sin_outliers2<-scale(Datos2.2_con_media[,6:15])

boxplot(sca_sin_outliers,main="Outliers después de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```

### Estudio 3

#### Eliminar los outliers

```{r}
# Función para eliminar outliers de columnas específicas
eliminar_outliers_columnas <- function(datos, columnas) {
  # Inicializar el dataframe sin outliers
  datos_sin_outliers <- datos
  
  for (columna in columnas) {
    # Calcular los cuartiles y el IQR de la columna
    Q1 <- quantile(datos[[columna]], 0.25)
    Q3 <- quantile(datos[[columna]], 0.75)
    IQR <- Q3 - Q1
    
    # Definir los límites inferior y superior
    limite_inferior <- Q1 - 1.5 * IQR
    limite_superior <- Q3 + 1.5 * IQR
    
    # Filtrar las filas que están dentro de los límites
    datos_sin_outliers <- datos_sin_outliers[datos_sin_outliers[[columna]] >= limite_inferior & datos_sin_outliers[[columna]] <= limite_superior, ]
  }
  
  return(datos_sin_outliers)
}

columnas_a_usar <- c(6:15)
Datos3_sin_outliers <- eliminar_outliers_columnas(Datos3, columnas_a_usar)
#print(Datos3_sin_outliers)
```
Comprobemos gráficamente la eliminación de los outliers.

```{r}
par(mfrow = c(1, 2))
boxplot(Datos3[,6:15],main="Outliers antes de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
boxplot(Datos3_sin_outliers[,6:15],main="Outliers después de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```

Estandarizamos.
```{r}
par(mfrow = c(1, 2))
sca<-scale(Datos3[,6:15])

boxplot(sca,main="Outliers antes de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))

sca_sin_outliers<-scale(Datos3_sin_outliers[,6:15])

boxplot(sca_sin_outliers,main="Outliers después de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```

#### Cambiar los outliers por la media

```{r}

outlier<-function(data,na.rm=T){
  H<-1.5*IQR(data) 
  data[data<quantile(data,0.25,na.rm = T)-H]<-NA 
  data[data>quantile(data,0.75, na.rm = T)+H]<-NA 
  data[is.na(data)]<-mean(data, na.rm = T) 
  H<-1.5*IQR(data)
  
  if (TRUE %in% (data<quantile(data,0.25,na.rm = T)-H) | 
      TRUE %in% (data>quantile(data,0.75,na.rm = T)+H))
    outlier(data) 
  else
    return(data) 
}

Datos3_con_media<-Datos3
#Llamamos a la función de outliers para cada variable en la que hemos identificado un outlier
#Sería suficiente fijarnos en las gráficas donde hay outliers y no llamar a la función para todas las variables

Datos3_con_media[[6]]<-outlier(Datos3_con_media[[6]]) 
Datos3_con_media[[7]]<-outlier(Datos3_con_media[[7]])  
Datos3_con_media[[8]]<-outlier(Datos3_con_media[[8]]) 
Datos3_con_media[[9]]<-outlier(Datos3_con_media[[9]]) 
Datos3_con_media[[10]]<-outlier(Datos3_con_media[[10]]) 
Datos3_con_media[[11]]<-outlier(Datos3_con_media[[11]]) 
Datos3_con_media[[12]]<-outlier(Datos3_con_media[[12]]) 
Datos3_con_media[[13]]<-outlier(Datos3_con_media[[13]]) 
Datos3_con_media[[14]]<-outlier(Datos3_con_media[[14]]) 
Datos3_con_media[[15]]<-outlier(Datos3_con_media[[15]])


```

Comprobemos gráficamente el cambio de los outliers por la media.

```{r}

par(mfrow = c(1, 2))
boxplot(Datos3[,6:15],main="Outliers antes de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
boxplot(Datos3_con_media[,6:15],main="Outliers después de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```


Estandarizamos.
```{r}
par(mfrow = c(1, 2))
sca<-scale(Datos3[,6:15])

boxplot(sca,main="Outliers antes de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))

sca_sin_outliers3<-scale(Datos3_con_media[,6:15])

boxplot(sca_sin_outliers,main="Outliers después de quitarlos",
        xlab="All explanatory variables",
        ylab="Values",
        col=rainbow(10))
```

## Análisis de Componentes Principales
Ahora, ya sin valores perdidos (los hemos eliminado), ni outliers (los hemos sustituido), hacemos ACP (Análisis de Componentes Principales)

### Estudio de la correlación de las variables entre sí

#### Estudio 1

```{r}
matriz_correlacion1<-cor(Datos1[6:15])
matriz_correlacion1
det(matriz_correlacion1)
```

####  Estudio 2
```{r}
matriz_correlacion2<-cor(Datos2.2[6:15])
matriz_correlacion2
det(matriz_correlacion2)
```

#### Estudio 3
```{r}
matriz_correlacion3<-cor(Datos3[6:15])
matriz_correlacion3
det(matriz_correlacion3)
```

### Test de Bartlett

#### Estudio 1
```{r}
#dim(sca_sin_outliers1)
cortest.bartlett(cor(sca_sin_outliers1),n=56)

```

#### Estudio 2
```{r}
#dim(sca_sin_outliers2)
cortest.bartlett(cor(sca_sin_outliers2),n=38)
```

#### Estudio 3
```{r}
#dim(sca_sin_outliers3)
cortest.bartlett(cor(sca_sin_outliers3),n=36)
```

### Análisis de Componentes Principales

#### Estudio 1
```{r}
PCA_1<-prcomp(Datos1_con_media[6:15], scale=T, center = T)
PCA_1$rotation
```
Vamos a calcular la desviación estándar de cada componente principal, la proporción de varianza explicada y la proporción de varianza explicada acumulada.
```{r}
summary(PCA_1)
```

La siguiente gráfica muestra la proporción de varianza explicada.
```{r}
Explained_variance <- PCA_1$sdev^2 / sum(PCA_1$sdev^2)

ggplot(data = data.frame(Explained_variance, pc = 1:10),
           aes(x = pc, y = Explained_variance, fill=Explained_variance )) + 
  geom_col(width = 0.3) + scale_y_continuous(limits = c(0,0.6)) + theme_bw() + 
  labs(x = "Principal component", y= "Proportion of variance")
```

La siguiente gráfica muestra la proporción de varianza explicada.
```{r}
Cummulative_variance<-cumsum(Explained_variance)
ggplot( data = data.frame(Cummulative_variance, pc = 1:10),
            aes(x = pc, y = Cummulative_variance ,fill=Cummulative_variance )) + 
  geom_col(width = 0.5) + scale_y_continuous(limits = c(0,1)) + theme_bw() + 
  labs(x = "Principal component",
       y = "Proportion of cumulative variance")
```

Vemos cuántas componentes principales son adecuadas, usando la regla de Abdi:
Las varianzas explicadas por los componentes principales se promedian, y se seleccionan aquellas cuya proporción de varianza explicada supera la media.

```{r}
PCA_1$sdev^2
mean(PCA_1$sdev^2)
```
Observamos que hay 4 por encima de la media, así que estudiamos el caso de 4 componentes principales.
Esta gráfica muestra la proyección de las variables en dos dimensiones. Muestra el peso de la variable en la dirección de la componente principal.

```{r, message= FALSE}
#install.packages("ggplot2")
library(ggplot2)
#install.packages("factoextra")
library(factoextra)
#install.packages("gridExtra")
library(gridExtra)
```


```{r,fig.width=20, fig.height=15}
# Gráfico 1: PC1 vs PC2
p1 <- fviz_pca_var(PCA_1, axes = c(1, 2), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC1 vs PC2") + theme_bw()

# Gráfico 2: PC1 vs PC3
p2 <- fviz_pca_var(PCA_1, axes = c(1, 3), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC1 vs PC3") + theme_bw()

# Gráfico 3: PC1 vs PC4
p3 <- fviz_pca_var(PCA_1, axes = c(1, 4), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC1 vs PC4") + theme_bw()

# Gráfico 4: PC2 vs PC3
p4 <- fviz_pca_var(PCA_1, axes = c(2, 3), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC2 vs PC3") + theme_bw()

# Gráfico 5: PC2 vs PC4
p5 <- fviz_pca_var(PCA_1, axes = c(2, 4), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC2 vs PC4") + theme_bw()

# Gráfico 6: PC3 vs PC4
p6 <- fviz_pca_var(PCA_1, axes = c(3, 4), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC3 vs PC4") + theme_bw()
grid.arrange(p1, p2, p3, p4, p5, p6, nrow = 3)

```

Estos resultados gráficos muestran las observaciones con su contribución a la varianza. Así como identificar con colores aquellas observaciones que explican la mayor varianza de los componentes principales.
```{r,fig.width=20, fig.height=15}
# Gráfico 1: PC1 vs PC2
p1 <- fviz_pca_ind(PCA_1, col.ind = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                   repel = TRUE, legend.title = "Contrib.var", title = "PC1 vs PC2") + theme_bw()

# Gráfico 2: PC1 vs PC3
p2 <- fviz_pca_ind(PCA_1, axes = c(1, 3), col.ind = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                   repel = TRUE, legend.title = "Contrib.var", title = "PC1 vs PC3") + theme_bw()

# Gráfico 3: PC1 vs PC4
p3 <- fviz_pca_ind(PCA_1, axes = c(1, 4), col.ind = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                   repel = TRUE, legend.title = "Contrib.var", title = "PC1 vs PC4") + theme_bw()

# Gráfico 4: PC2 vs PC3
p4 <- fviz_pca_ind(PCA_1, axes = c(2, 3), col.ind = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                   repel = TRUE, legend.title = "Contrib.var", title = "PC2 vs PC3") + theme_bw()

# Gráfico 5: PC2 vs PC4
p5 <- fviz_pca_ind(PCA_1, axes = c(2, 4), col.ind = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                   repel = TRUE, legend.title = "Contrib.var", title = "PC2 vs PC4") + theme_bw()

# Gráfico 6: PC3 vs PC4
p6 <- fviz_pca_ind(PCA_1, axes = c(3, 4), col.ind = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                   repel = TRUE, legend.title = "Contrib.var", title = "PC3 vs PC4") + theme_bw()
grid.arrange(p1, p2, p3, p4, p5, p6, nrow = 3)

```

Estos resultados gráficos muestran las variables y las observaciones con su contribución a la varianza. Identifica las posibles relaciones entre las contribuciones de los registros a las varianzas de los componentes y el peso de las variables en cada componente principal.

```{r,fig.width=20, fig.height=15}
# Gráfico 1: PC1 vs PC2
p1 <- fviz_pca(PCA_1, alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

# Gráfico 2: PC1 vs PC3
p2 <- fviz_pca(PCA_1, axes = c(1, 3), alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

# Gráfico 3: PC1 vs PC4
p3 <- fviz_pca(PCA_1, axes = c(1, 4), alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

# Gráfico 4: PC2 vs PC3
p4 <- fviz_pca(PCA_1, axes = c(2, 3), alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

# Gráfico 5: PC2 vs PC4
p5 <- fviz_pca(PCA_1, axes = c(2, 4), alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

# Gráfico 6: PC3 vs PC4
p6 <- fviz_pca(PCA_1, axes = c(3, 4), alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

grid.arrange(p1, p2, p3, p4, p5, p6, nrow = 3)

```
Mostramos las coordenadas en el nuevo sistema de referencia

```{r}
head(PCA_1$x)
```


#### Estudio 2

```{r}
PCA_2<-prcomp(Datos2.2_con_media[6:15], scale=T, center = T)
PCA_2$rotation
```
Vamos a calcular la desviación estándar de cada componente principal, la proporción de varianza explicada y la proporción de varianza explicada acumulada.
```{r}
summary(PCA_2)
```

La siguiente gráfica muestra la proporción de varianza explicada.
```{r}
Explained_variance <- PCA_2$sdev^2 / sum(PCA_2$sdev^2)

ggplot(data = data.frame(Explained_variance, pc = 1:10),
           aes(x = pc, y = Explained_variance, fill=Explained_variance )) + 
  geom_col(width = 0.3) + scale_y_continuous(limits = c(0,0.6)) + theme_bw() + 
  labs(x = "Principal component", y= "Proportion of variance")
```

La siguiente gráfica muestra la proporción de varianza explicada.
```{r}
Cummulative_variance<-cumsum(Explained_variance)
ggplot( data = data.frame(Cummulative_variance, pc = 1:10),
            aes(x = pc, y = Cummulative_variance ,fill=Cummulative_variance )) + 
  geom_col(width = 0.5) + scale_y_continuous(limits = c(0,1)) + theme_bw() + 
  labs(x = "Principal component",
       y = "Proportion of cumulative variance")
```

Vemos cuántas componentes principales son adecuadas, usando la regla de Abdi:
Las varianzas explicadas por los componentes principales se promedian, y se seleccionan aquellas cuya proporción de varianza explicada supera la media.

```{r}
PCA_2$sdev^2
mean(PCA_2$sdev^2)
```
Observamos que hay 4 por encima de la media, así que estudiamos el caso de 4 componentes principales.
Esta gráfica muestra la proyección de las variables en dos dimensiones. Muestra el peso de la variable en la dirección de la componente principal.

```{r,fig.width=20, fig.height=15}
# Gráfico 1: PC1 vs PC2
p1 <- fviz_pca_var(PCA_2, axes = c(1, 2), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC1 vs PC2") + theme_bw()

# Gráfico 2: PC1 vs PC3
p2 <- fviz_pca_var(PCA_2, axes = c(1, 3), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC1 vs PC3") + theme_bw()

# Gráfico 3: PC1 vs PC4
p3 <- fviz_pca_var(PCA_2, axes = c(1, 4), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC1 vs PC4") + theme_bw()

# Gráfico 4: PC2 vs PC3
p4 <- fviz_pca_var(PCA_2, axes = c(2, 3), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC2 vs PC3") + theme_bw()

# Gráfico 5: PC2 vs PC4
p5 <- fviz_pca_var(PCA_2, axes = c(2, 4), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC2 vs PC4") + theme_bw()

# Gráfico 6: PC3 vs PC4
p6 <- fviz_pca_var(PCA_2, axes = c(3, 4), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC3 vs PC4") + theme_bw()
grid.arrange(p1, p2, p3, p4, p5, p6, nrow = 3)

```

Estos resultados gráficos muestran las observaciones con su contribución a la varianza. Así como identificar con colores aquellas observaciones que explican la mayor varianza de los componentes principales.
```{r,fig.width=20, fig.height=15}
# Gráfico 1: PC1 vs PC2
p1 <- fviz_pca_ind(PCA_2, col.ind = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                   repel = TRUE, legend.title = "Contrib.var", title = "PC1 vs PC2") + theme_bw()

# Gráfico 2: PC1 vs PC3
p2 <- fviz_pca_ind(PCA_2, axes = c(1, 3), col.ind = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                   repel = TRUE, legend.title = "Contrib.var", title = "PC1 vs PC3") + theme_bw()

# Gráfico 3: PC1 vs PC4
p3 <- fviz_pca_ind(PCA_2, axes = c(1, 4), col.ind = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                   repel = TRUE, legend.title = "Contrib.var", title = "PC1 vs PC4") + theme_bw()

# Gráfico 4: PC2 vs PC3
p4 <- fviz_pca_ind(PCA_2, axes = c(2, 3), col.ind = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                   repel = TRUE, legend.title = "Contrib.var", title = "PC2 vs PC3") + theme_bw()

# Gráfico 5: PC2 vs PC4
p5 <- fviz_pca_ind(PCA_2, axes = c(2, 4), col.ind = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                   repel = TRUE, legend.title = "Contrib.var", title = "PC2 vs PC4") + theme_bw()

# Gráfico 6: PC3 vs PC4
p6 <- fviz_pca_ind(PCA_2, axes = c(3, 4), col.ind = "contrib", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                   repel = TRUE, legend.title = "Contrib.var", title = "PC3 vs PC4") + theme_bw()
grid.arrange(p1, p2, p3, p4, p5, p6, nrow = 3)

```


Estos resultados gráficos muestran las variables y las observaciones con su contribución a la varianza. Identifica las posibles relaciones entre las contribuciones de los registros a las varianzas de los componentes y el peso de las variables en cada componente principal.

```{r,fig.width=20, fig.height=15}
# Gráfico 1: PC1 vs PC2
p1 <- fviz_pca(PCA_2, alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

# Gráfico 2: PC1 vs PC3
p2 <- fviz_pca(PCA_2, axes = c(1, 3), alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

# Gráfico 3: PC1 vs PC4
p3 <- fviz_pca(PCA_2, axes = c(1, 4), alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

# Gráfico 4: PC2 vs PC3
p4 <- fviz_pca(PCA_2, axes = c(2, 3), alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

# Gráfico 5: PC2 vs PC4
p5 <- fviz_pca(PCA_2, axes = c(2, 4), alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

# Gráfico 6: PC3 vs PC4
p6 <- fviz_pca(PCA_2, axes = c(3, 4), alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

grid.arrange(p1, p2, p3, p4, p5, p6, nrow = 3)

```
Mostramos las coordenadas en el nuevo sistema de referencia

```{r}
head(PCA_2$x)

```

#### Estudio 3

```{r}
PCA_3<-prcomp(Datos3_con_media[6:15], scale=T, center = T)
PCA_3$rotation
```
Vamos a calcular la desviación estándar de cada componente principal, la proporción de varianza explicada y la proporción de varianza explicada acumulada.
```{r}
summary(PCA_3)
```

La siguiente gráfica muestra la proporción de varianza explicada.
```{r}
Explained_variance <- PCA_3$sdev^2 / sum(PCA_3$sdev^2)

ggplot(data = data.frame(Explained_variance, pc = 1:10),
           aes(x = pc, y = Explained_variance, fill=Explained_variance )) + 
  geom_col(width = 0.3) + scale_y_continuous(limits = c(0,0.6)) + theme_bw() + 
  labs(x = "Principal component", y= "Proportion of variance")
```

La siguiente gráfica muestra la proporción de varianza explicada.
```{r}
Cummulative_variance<-cumsum(Explained_variance)
ggplot( data = data.frame(Cummulative_variance, pc = 1:10),
            aes(x = pc, y = Cummulative_variance ,fill=Cummulative_variance )) + 
  geom_col(width = 0.5) + scale_y_continuous(limits = c(0,1)) + theme_bw() + 
  labs(x = "Principal component",
       y = "Proportion of cumulative variance")
```

Vemos cuántas componentes principales son adecuadas, usando la regla de Abdi:
Las varianzas explicadas por los componentes principales se promedian, y se seleccionan aquellas cuya proporción de varianza explicada supera la media.

```{r}
PCA_3$sdev^2
mean(PCA_3$sdev^2)
```
Observamos que hay 3 por encima de la media, así que estudiamos el caso de 3 componentes principales.
Esta gráfica muestra la proyección de las variables en dos dimensiones. Muestra el peso de la variable en la dirección de la componente principal.

```{r,fig.width=20, fig.height=15}
# Gráfico 1: PC1 vs PC2
p1 <- fviz_pca_var(PCA_3, axes = c(1, 2), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC1 vs PC2") + theme_bw()

# Gráfico 2: PC1 vs PC3
p2 <- fviz_pca_var(PCA_3, axes = c(1, 3), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC1 vs PC3") + theme_bw()

# Gráfico 3: PC2 vs PC3
p3 <- fviz_pca_var(PCA_3, axes = c(2, 3), repel = TRUE, col.var = "cos2",
                   legend.title = "Distance", title = "PC2 vs PC3") + theme_bw()

grid.arrange(p1, p2, p3, nrow = 2)

```

Estos resultados gráficos muestran las observaciones con su contribución a la varianza. Así como identificar con colores aquellas observaciones que explican la mayor varianza de los componentes principales.

```{r,fig.width=15, fig.height=10}
# Gráfico 1: PC1 vs PC2
p1<-fviz_pca_ind(PCA_3,col.ind = "contrib",
                 gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
                 repel=TRUE,legend.title="Contrib.var", title="Records")+theme_bw()

# Gráfico 2: PC1 vs PC3
p2<-fviz_pca_ind(PCA_3,axes=c(1,3),col.ind = "contrib", 
                 gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                 repel=TRUE,legend.title="Contrib.var", title="Records")+theme_bw()

# Gráfico 1: PC2 vs PC3
p3<-fviz_pca_ind(PCA_3,axes=c(2,3),col.ind = "contrib", 
                 gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                 repel=TRUE,legend.title="Contrib.var", title="Records")+theme_bw()

grid.arrange(p1, p2, p3, nrow = 2)

```


Estos resultados gráficos muestran las variables y las observaciones con su contribución a la varianza. Identifica las posibles relaciones entre las contribuciones de los registros a las varianzas de los componentes y el peso de las variables en cada componente principal.

```{r,fig.width=15, fig.height=10}
# Gráfico 1: PC1 vs PC2
p1 <- fviz_pca(PCA_3, alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

# Gráfico 2: PC1 vs PC3
p2 <- fviz_pca(PCA_3, axes = c(1, 3), alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

# Gráfico 3: PC2 vs PC3
p3 <- fviz_pca(PCA_3, axes = c(2, 3), alpha.ind = "contrib", col.var = "cos2", col.ind = "seagreen",
               gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"), repel = TRUE, legend.title = "Distancia") + theme_bw()

grid.arrange(p1, p2, p3, nrow = 2)

```
Mostramos las coordenadas en el nuevo sistema de referencia

```{r}
head(PCA_3$x)
#print(PCA_3$x)
#print(PCA_3)

```

## Estudio de la  normalidad
```{r, message= FALSE}
library(reshape2)
library(MVN)
library(biotools)
library(klaR)
library(caret)
```
Previo a la construcción de métodos de clasificación se debe analizar la normalidad multivariante de los datos con el test propuesto en clase de prácticas de análisis discriminante.
#### Estudio 1
```{r}
PCA_1scores<-as.data.frame(PCA_1$x[,1:4])
outliers1 <- mvn(data = PCA_1scores, mvnTest = "hz", multivariateOutlierMethod = "quan")
```

#### Estudio 2

```{r}
PCA_2scores<-as.data.frame(PCA_2$x[,1:4])
outliers2 <- mvn(data = PCA_2scores, mvnTest = "hz", multivariateOutlierMethod = "quan")

```

#### Estudio 3

```{r}
PCA_3scores<-as.data.frame(PCA_3$x[,1:3])
outliers3 <- mvn(data = PCA_3scores, mvnTest = "hz", multivariateOutlierMethod = "quan")

```

### Royston multivariate normality test
#### Estudio 1
```{r}
royston_test1 <- mvn(data = PCA_1scores, mvnTest = "royston", multivariatePlot = "qq")
royston_test1$multivariateNormality
```
#### Estudio 2
```{r}
royston_test2 <- mvn(data = PCA_2scores, mvnTest = "royston", multivariatePlot = "qq")
royston_test2$multivariateNormality
```
#### Estudio 3
```{r}
royston_test3 <- mvn(data = PCA_3scores, mvnTest = "royston", multivariatePlot = "qq")
royston_test3$multivariateNormality
```

### Henze-Zirkler multivariate normality test
#### Estudio 1
```{r}
hz_test1 <- mvn(data = PCA_1scores, mvnTest = "hz") 
hz_test1$multivariateNormality
```
#### Estudio 2
```{r}
hz_test2 <- mvn(data = PCA_2scores, mvnTest = "hz") 
hz_test2$multivariateNormality
```
#### Estudio 3
```{r}
hz_test3 <- mvn(data = PCA_3scores, mvnTest = "hz") 
hz_test3$multivariateNormality
```
Las variables respuesta (dependientes) serían: Tb.Sp, Tb.N, BMC, BMD, Longitud, GPSurface, GPVolume.

Las variables independientes (predictoras) serían: Grupo, Dosis, DiasDosis,Peso, PesoInicial, Peso Intermedio, DiasEspera.


## Análisis clúster
```{r, message= FALSE}
library(cluster)
library(ggdendro)
library(gridExtra)
library(tidyverse)
```
Reescalamos las componentes principales
```{r}
PCA_1scores_scale<-PCA_1scores
PCA_1scores_scale<-as.data.frame(scale(PCA_1scores_scale))

PCA_2scores_scale<-PCA_2scores
PCA_2scores_scale<-as.data.frame(scale(PCA_2scores_scale))

PCA_3scores_scale<-PCA_3scores
PCA_3scores_scale<-as.data.frame(scale(PCA_3scores_scale))
```


Hacemos la matriz de distancia para cada estudio.

#### Estudio 1
```{r}
distance<- get_dist(PCA_1scores_scale)
fviz_dist(distance, gradient = list(low ="yellow", mid = "white", high = "brown"))
```

#### Estudio 2
```{r}
distance<- get_dist(PCA_2scores_scale)
fviz_dist(distance, gradient = list(low ="yellow", mid = "white", high = "brown"))
```

#### Estudio 3
```{r}
distance<- get_dist(PCA_3scores_scale)
fviz_dist(distance, gradient = list(low ="yellow", mid = "white", high = "brown"))
```


### Clustering jerárquico - método de Ward
Hacemos los dendogramas.

#### Estudio 1
```{r}
dendrogram <- hclust(dist(PCA_1scores_scale, method = 'euclidean'), method = 'ward.D') 
ggdendrogram(dendrogram, rotate = FALSE, labels = FALSE, theme_dendro = TRUE) +
  labs(title = "Dendrograma")
```

#### Estudio 2
```{r}
dendrogram <- hclust(dist(PCA_2scores_scale, method = 'euclidean'), method = 'ward.D') 
ggdendrogram(dendrogram, rotate = FALSE, labels = FALSE, theme_dendro = TRUE) +
  labs(title = "Dendrograma")
```

#### Estudio 3
```{r}
dendrogram <- hclust(dist(PCA_3scores_scale, method = 'euclidean'), method = 'ward.D') 
ggdendrogram(dendrogram, rotate = FALSE, labels = FALSE, theme_dendro = TRUE) +
  labs(title = "Dendrograma")
```


### Clustering no jerárquico - algoritmo K-means
#### Estudio 1

```{r}
set.seed(123)

k2_1 <- kmeans(PCA_1scores_scale, centers = 2, nstart = 25)
k3_1 <- kmeans(PCA_1scores_scale, centers = 3, nstart = 25) 
k4_1 <- kmeans(PCA_1scores_scale, centers = 4, nstart = 25) 
k5_1 <- kmeans(PCA_1scores_scale, centers = 5, nstart = 25)
k6_1 <- kmeans(PCA_1scores_scale, centers = 6, nstart = 25)
k7_1 <- kmeans(PCA_1scores_scale, centers = 7, nstart = 25)
k9_1 <- kmeans(PCA_1scores_scale, centers = 9, nstart = 25)
# Plots to compare
fviz_cluster(k2_1, data = PCA_1scores_scale) + ggtitle("k = 2") 
fviz_cluster(k3_1, data = PCA_1scores_scale) + ggtitle("k = 3") 
fviz_cluster(k4_1, data = PCA_1scores_scale) + ggtitle("k = 4") 
fviz_cluster(k5_1, data = PCA_1scores_scale) + ggtitle("k = 5")
fviz_cluster(k6_1, data = PCA_1scores_scale) + ggtitle("k = 6") 
fviz_cluster(k7_1, data = PCA_1scores_scale) + ggtitle("k = 7")
fviz_cluster(k9_1, data = PCA_1scores_scale) + ggtitle("k = 9") 

```

Apliquemos el método de Elbow, de Silhouette y el del estadístico de brecha para ver el número óptimo de clústers.
##### Método de Elbow
```{r}
set.seed(123)
fviz_nbclust(PCA_1scores_scale, kmeans, method = "wss")
```

##### Método de Silhouette
```{r}
set.seed(123)
fviz_nbclust(PCA_1scores_scale, kmeans, method = "silhouette")
```

##### Método estadístico de brecha (GAP)
```{r}
set.seed(123)
gap_stat <- clusGap(PCA_1scores_scale, FUN = kmeans, nstart = 25,K.max = 10, B = 50) 
fviz_gap_stat(gap_stat)
```


#### Estudio 2
```{r}
set.seed(123)
k2_2 <- kmeans(PCA_2scores_scale, centers = 2, nstart = 25)
k3_2 <- kmeans(PCA_2scores_scale, centers = 3, nstart = 25) 
k4_2 <- kmeans(PCA_2scores_scale, centers = 4, nstart = 25) 
k5_2 <- kmeans(PCA_2scores_scale, centers = 5, nstart = 25)
# Plots to compare
fviz_cluster(k2_2, data = PCA_2scores_scale) + ggtitle("k = 2") 
fviz_cluster(k3_2, data = PCA_2scores_scale) + ggtitle("k = 3") 
fviz_cluster(k4_2, data = PCA_2scores_scale) + ggtitle("k = 4") 
fviz_cluster(k5_2, data = PCA_2scores_scale) + ggtitle("k = 5")

```

Apliquemos el método de Elbow, de Silhouette y el del estadístico de brecha para ver el número óptimo de clústers.
##### Método de Elbow
```{r}
set.seed(123)
fviz_nbclust(PCA_2scores_scale, kmeans, method = "wss")

```

##### Método de Silhouette
```{r}
set.seed(123)
fviz_nbclust(PCA_2scores_scale, kmeans, method = "silhouette")
```

##### Método estadístico de brecha (GAP)
```{r}
set.seed(123)
gap_stat <- clusGap(PCA_2scores_scale, FUN = kmeans, nstart = 25,K.max = 10, B = 50) 
fviz_gap_stat(gap_stat)
```


#### Estudio 3 ( sin escalar )

```{r}
set.seed(123)
k2_3 <- kmeans(PCA_3scores, centers = 2, nstart = 25)
k3_3 <- kmeans(PCA_3scores, centers = 3, nstart = 25) 
k4_3 <- kmeans(PCA_3scores, centers = 4, nstart = 25) 
k5_3 <- kmeans(PCA_3scores, centers = 5, nstart = 25)
# Plots to compare
fviz_cluster(k2_3, data = PCA_3scores) + ggtitle("k = 2")
fviz_cluster(k3_3, data = PCA_3scores) + ggtitle("k = 3")
fviz_cluster(k4_3, data = PCA_3scores) + ggtitle("k = 4")
fviz_cluster(k5_3, data = PCA_3scores) + ggtitle("k = 5")

```

Apliquemos el método de Elbow, de Silhouette y el del estadístico de brecha para ver el número óptimo de clústers.
##### Método de Elbow

```{r}
set.seed(123)
fviz_nbclust(PCA_3scores_scale, kmeans, method = "wss")
```

##### Método de Silhouette

```{r}
set.seed(123)
fviz_nbclust(PCA_3scores_scale, kmeans, method = "silhouette")
```

##### Método estadístico de brecha (GAP)

```{r}
set.seed(123)
gap_stat <- clusGap(PCA_3scores_scale, FUN = kmeans, nstart = 25,K.max = 10, B = 50) 
fviz_gap_stat(gap_stat)
```

### Análisis final
Veamos el número óptimo de clusters. Calculamos vectores de medias de 2, 3 y 4 clusters.
#### Estudio 1
##### Vectores de medias con 2 cluster.
```{r}
Datos1_con_media$Cluster2 <- k2_1$cluster
Datos1_con_media$Cluster3 <- k3_1$cluster
Datos1_con_media$Cluster4 <- k4_1$cluster

#print(Datos1_con_media)

colMeans(subset(Datos1_con_media[3:17], Cluster2 == 1))
colMeans(subset(Datos1_con_media[3:17], Cluster2 == 2))
```

##### Vectores de medias con 3 cluster.
```{r}

colMeans(subset(Datos1_con_media[3:18], Cluster3 == 1))
colMeans(subset(Datos1_con_media[3:18], Cluster3 == 2))
colMeans(subset(Datos1_con_media[3:18], Cluster3 == 3))
#print(Datos3_con_media)
#dim(Datos3_con_media)
#dim(Datos1_con_media)
#print(Datos1_con_media)
```

##### Vectores de medias con 4 cluster.
```{r}
colMeans(subset(Datos1_con_media[3:19], Cluster4 == 1))
colMeans(subset(Datos1_con_media[3:19], Cluster4 == 2))
colMeans(subset(Datos1_con_media[3:19], Cluster4 == 3))
colMeans(subset(Datos1_con_media[3:19], Cluster4 == 4))
```

#### Estudio 2
##### Vectores de medias con 2 cluster.
```{r}
Datos2.2_con_media$Cluster2 <- k2_2$cluster
Datos2.2_con_media$Cluster3 <- k3_2$cluster
Datos2.2_con_media$Cluster4 <- k4_2$cluster

colMeans(subset(Datos2.2_con_media[3:17], Cluster2 == 1))
colMeans(subset(Datos2.2_con_media[3:17], Cluster2 == 2))
```

##### Vectores de medias con 3 cluster.
```{r}

colMeans(subset(Datos2.2_con_media[3:18], Cluster3 == 1))
colMeans(subset(Datos2.2_con_media[3:18], Cluster3 == 2))
colMeans(subset(Datos2.2_con_media[3:18], Cluster3 == 3))
```

##### Vectores de medias con 4 cluster.
```{r}
colMeans(subset(Datos2.2_con_media[3:19], Cluster4 == 1))
colMeans(subset(Datos2.2_con_media[3:19], Cluster4 == 2))
colMeans(subset(Datos2.2_con_media[3:19], Cluster4 == 3))
colMeans(subset(Datos2.2_con_media[3:19], Cluster4 == 4))
```

#### Estudio 3
##### Vectores de medias con 2 cluster.
```{r}
Datos3_con_media$Cluster2 <- k2_3$cluster
Datos3_con_media$Cluster3 <- k3_3$cluster
Datos3_con_media$Cluster4 <- k4_3$cluster

colMeans(subset(Datos3_con_media[3:17], Cluster2 == 1))
colMeans(subset(Datos3_con_media[3:17], Cluster2 == 2))
```

##### Vectores de medias con 3 cluster.
```{r}

colMeans(subset(Datos3_con_media[3:18], Cluster3 == 1))
colMeans(subset(Datos3_con_media[3:18], Cluster3 == 2))
colMeans(subset(Datos3_con_media[3:18], Cluster3 == 3))
```

##### Vectores de medias con 4 cluster.
```{r}
colMeans(subset(Datos3_con_media[3:19], Cluster4 == 1))
colMeans(subset(Datos3_con_media[3:19], Cluster4 == 2))
colMeans(subset(Datos3_con_media[3:19], Cluster4 == 3))
colMeans(subset(Datos3_con_media[3:19], Cluster4 == 4))
```

estudio 1  3 clusters
estudio 2  4 clusters
estudio 3  3 cluster